/* This Source Code Form is subject to the terms of the Mozilla Public
 * License, v. 2.0. If a copy of the MPL was not distributed with this
 * file, You can obtain one at http://mozilla.org/MPL/2.0/. */

import { DEFAULT_TELEMETRY_ENDPOINT, GLEAN_MAX_SOURCE_TAGS } from "./constants.js";
import type Plugin from "../plugins/index.js";
import { validateHeader, validateURL } from "./utils.js";
import type Uploader from "./upload/uploader.js";
import type { DebugOptions } from "./debug_options.js";
import log, { LoggingLevel } from "./log.js";
import { Context } from "./context.js";

const LOG_TAG = "core.Config";

/**
 * Describes how to configure Glean.
 */
export interface ConfigurationInterface {
  // Application release channel (e.g. "beta" or "nightly").
  readonly channel?: string,
  // The build identifier generated by the CI system (e.g. "1234/A").
  readonly appBuild?: string,
  // The user visible version string for the application running Glean.js.
  readonly appDisplayVersion?: string,
  // The server pings are sent to.
  readonly serverEndpoint?: string,
  // Optional list of plugins to include in current Glean instance.
  plugins?: Plugin[],
  // The HTTP client implementation to use for uploading pings.
  httpClient?: Uploader,
  // Qt-only fields
  //
  // These values are not easily accessible from QML,
  // so we expose them as init fields for the caller to fill them out.
  //
  // The architecture of the device (e.g. "arm", "x86").
  readonly architecture?: string,
  // The user-visible version of the operating system (e.g. "1.2.3").
  readonly osVersion?: string,
}

// Important: the `Configuration` should only be used internally by the Glean singleton.
export class Configuration implements ConfigurationInterface {
  // Application release channel (e.g. "beta" or "nightly").
  readonly channel?: string;
  // The build identifier generated by the CI system (e.g. "1234/A").
  readonly appBuild?: string;
  // The user visible version string fro the application running Glean.js.
  readonly appDisplayVersion?: string;
  // The server pings are sent to.
  readonly serverEndpoint: string;
  // The architecture of the device (e.g. "arm", "x86").
  readonly architecture?: string;
  // The user-visible version of the operating system (e.g. "1.2.3").
  readonly osVersion?: string;

  // Debug configuration.
  debug: DebugOptions;
  // The HTTP client implementation to use for uploading pings.
  httpClient?: Uploader;

  constructor(config?: ConfigurationInterface) {
    this.channel = config?.channel;
    this.appBuild = config?.appBuild;
    this.appDisplayVersion = config?.appDisplayVersion;
    this.architecture = config?.architecture;
    this.osVersion = config?.osVersion;

    this.debug = {};

    if (config?.serverEndpoint && !validateURL(config.serverEndpoint)) {
      throw new Error(
        `Unable to initialize Glean, serverEndpoint ${config.serverEndpoint} is an invalid URL.`);
    }

    if (!Context.testing && config?.serverEndpoint?.startsWith("http:")) {
      throw new Error(
        `Unable to initialize Glean, serverEndpoint ${config.serverEndpoint} must use the HTTPS protocol.`);
    }

    this.serverEndpoint = (config && config.serverEndpoint)
      ? config.serverEndpoint : DEFAULT_TELEMETRY_ENDPOINT;

    this.httpClient = config?.httpClient;
  }

  get debugViewTag(): string {
    return this.debug.debugViewTag || "";
  }

  set debugViewTag(tag: string) {
    if (!validateHeader(tag)) {
      log(
        LOG_TAG,
        [
          `"${tag}" is not a valid \`debugViewTag\` value.`,
          "Please make sure the value passed satisfies the regex `^[a-zA-Z0-9-]{1,20}$`."
        ],
        LoggingLevel.Error
      );

      return;
    }

    this.debug.debugViewTag = tag;
  }

  get sourceTags(): string[] {
    return this.debug.sourceTags || [];
  }

  set sourceTags(tags: string[]) {
    if (tags.length < 1 || tags.length > GLEAN_MAX_SOURCE_TAGS) {
      log(
        LOG_TAG,
        `A list of tags cannot contain more than ${GLEAN_MAX_SOURCE_TAGS} elements.`,
        LoggingLevel.Error
      );
      return;
    }

    for (const tag of tags) {
      if (tag.startsWith("glean")) {
        log(
          LOG_TAG,
          "Tags starting with `glean` are reserved and must not be used.",
          LoggingLevel.Error
        );
        return;
      }

      if (!validateHeader(tag)) {
        return;
      }
    }

    this.debug.sourceTags = tags;
  }
}
